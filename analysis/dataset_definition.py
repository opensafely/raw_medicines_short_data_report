# import ehrql libraries
from ehrql import create_dataset, show
from ehrql.tables.tpp import patients, practice_registrations, ons_deaths
from ehrql.tables.raw.tpp import repeat_medications, medications

# get codelists
import codelists

# create dataset from dummy tables generated by ehrQL
dataset = create_dataset()

# define start of period of interest
index_date = "2025-01-01"

# require registration to exist 
has_registration = practice_registrations.for_patient_on(
    index_date
).exists_for_patient()

# require patient to be alive/dead: use ONS record if present, otherwise use GP record
death_date = ons_deaths.date.when_null_then(patients.date_of_death)
was_alive = death_date.is_after(index_date) | death_date.is_null()

# define population
dataset.define_population(has_registration & was_alive)

# configure the dummy data
dataset.configure_dummy_data(
    population_size = 50
)

# restrict repeat medications table to after start date
repeat_medications = repeat_medications.where(repeat_medications.date.is_on_or_after(index_date))

# restrict medications table also
medications = medications.where(medications.date.is_on_or_after(index_date))

# get first row for each patient
medications_rows = (
    medications.sort_by(medications.date)
    .first_for_patient()
)

# get number of rows for meds table
dataset.meds_row_no = medications.count_for_patient()

# get number of unique repeat ids
dataset.meds_rep_id_no = medications.repeat_medication_id.count_distinct_for_patient()

# get number of rows for repeat meds table
dataset.repeats_row_no = repeat_medications.count_for_patient()

# get number of unique repeat ids
dataset.repeats_rep_id_no = repeat_medications.repeat_medication_id.count_distinct_for_patient()

# get whether the number of unique ids differs per patient
dataset.rep_ids_differ = dataset.meds_rep_id_no != dataset.repeats_rep_id_no

# get number of occasions start_date and consultation date are same per patient
dataset.concordant_dates = (
    repeat_medications.where(repeat_medications.date == repeat_medications.start_date)
    .date
    .count_distinct_for_patient()
)

# get number of occasions start_date and consultation date are different per patient
dataset.discordant_dates = (
    repeat_medications.where(repeat_medications.date != repeat_medications.start_date)
    .date
    .count_distinct_for_patient()
)

show(dataset)